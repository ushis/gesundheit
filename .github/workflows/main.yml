name: "build"
on: "push"

env:
  CGO_ENABLED: "0"
  GOOS: "linux"

jobs:
  build:
    runs-on: "ubuntu-latest"
    strategy:
      matrix:
        arch: ["386", "amd64", "arm", "arm64"]
    steps:
      - uses: "actions/checkout@v2"
      - uses: "actions/setup-go@v2"
        with:
          go-version: ">=1.17.7"
      - run: "go build -v -a -o gesundheit-${GITHUB_REF##*/}-${{ matrix.arch }} ."
        env:
          GOARCH: "${{ matrix.arch }}"
      - if: startsWith(github.ref, 'refs/tags/')
        uses: "softprops/action-gh-release@v1"
        with:
          files: "gesundheit-*"

  pkgbuild-x86_64:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: "ubuntu-latest"
    container: archlinux/archlinux:base-devel
    steps:
      - run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git go
      - run: |
          useradd -m build
          mkdir /build
          chown build:build /build
      - run: |
          echo -n "${PACKAGE_SIGNING_KEY}" | su build -c "gpg --import"
        env:
          PACKAGE_SIGNING_KEY: ${{ secrets.PACKAGE_SIGNING_KEY }}
      - run: |
          cd /build
          su build -c "curl -LO https://raw.githubusercontent.com/ushis/gesundheit/${GITHUB_REF##*/}/PKGBUILD"
          su build -c "sed -i 's/pkgver=.\+/pkgver=${GITHUB_REF##*/}/g' PKGBUILD"
          su build -c "makepkg --sign --skipchecksums"
          su build -c "repo-add gesundheit.db.tar.gz gesundheit-*.pkg.tar.zst"
          su build -c "gpg --export --armor" > gesundheit.pem
      - uses: "actions/checkout@v2"
        with:
          ref: gh-pages
          path: pages
      - run: |
          cd pages
          cp /build/gesundheit.pem .
          mkdir -p x86_64
          cp /build/gesundheit{-*.pkg.*,.db*,.files*} x86_64
          (for f in {,**/}gesundheit*; do echo "* [${f}](${f})"; done) > index.md
          git config user.name "Github Action"
          git config user.email "ushi+github-action@honkgong.info"
          git add .
          git commit -m "release ${GITHUB_REF##*/}"
          git push
